<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Transactions</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
        <div class="container mt-5">
            <h2>Upload Transactions</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Choose file</label>
                    <input type="file" class="form-control-file" id="file" name="file" accept=".csv,.xlsx,.xls">
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>

            <div id="dataPreview" class="mt-5" style="display: none;">
                <h3>Data Preview</h3>
                <table class="table table-striped">
                    <thead id="previewHead"></thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <button id="saveButton" class="btn btn-success">Save Transactions</button>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        $(document).ready(function() {
            const typeOptions = [
                { group: "Cash flows from operating activities", options: [
                    { value: "Cash-customer", text: "Cash receipts from customers" },
                    { value: "Salary-suppliers", text: "Cash payments to suppliers and employees" },
                    { value: "Interest-paid", text: "Interest paid" },
                    { value: "Income-tax", text: "Income taxes paid" },
                    { value: "Other-cfo", text: "Other operating cash flows" }
                ]},
                { group: "Cash flows from investing activities", options: [
                    { value: "Buy-property-equipments", text: "Purchase of property, plant, and equipment" },
                    { value: "Sell-property-equipments", text: "Proceeds from sale of property, plant, and equipment" },
                    { value: "Buy-investment", text: "Purchase of investments" },
                    { value: "Sell-investment", text: "Proceeds from sale of investments" },
                    { value: "Other-cfi", text: "Other investing cash flows" }
                ]},
                { group: "Cash flows from financing activities", options: [
                    { value: "Issue-shares", text: "Proceeds from issuing shares" },
                    { value: "borrowings", text: "Proceeds from borrowings" },
                    { value: "Repay-borrowings", text: "Repayment of borrowings" },
                    { value: "Pay-dividends", text: "Dividends paid" },
                    { value: "Other-cff", text: "Other financing cash flows" }
                ]}
            ];

            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    success: function(data) {
                        displayDataPreview(data);
                    },
                    error: function(xhr, status, error) {
                        alert('Error uploading file: ' + xhr.responseJSON.error);
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            function displayDataPreview(data) {
                var thead = $('#previewHead');
                var tbody = $('#previewBody');
                thead.empty();
                tbody.empty();

                // Create table headers
                var headerRow = $('<tr>');
                data.columns.forEach(function(column) {
                    headerRow.append($('<th>').text(column));
                });
                thead.append(headerRow);

                // Create table rows
                data.data.forEach(function(row) {
                    var tableRow = $('<tr>');
                    data.columns.forEach(function(column) {
                        if (column === 'type') {
                            var cell = $('<td>');
                            var select = createTypeSelect(row[column]);
                            cell.append(select);
                            tableRow.append(cell);
                        } else {
                            tableRow.append($('<td>').text(row[column]));
                        }
                    });
                    tbody.append(tableRow);
                });

                $('#dataPreview').show();
            }

            function createTypeSelect(currentValue) {
                var select = $('<select>').addClass('form-control');
                typeOptions.forEach(function(group) {
                    var optgroup = $('<optgroup>').attr('label', group.group);
                    group.options.forEach(function(option) {
                        var optionElement = $('<option>').val(option.value).text(option.text);
                        if (option.value === currentValue) {
                            optionElement.attr('selected', 'selected');
                        }
                        optgroup.append(optionElement);
                    });
                    select.append(optgroup);
                });
                return select;
            }

            $('#saveButton').on('click', function() {
                var data = [];
                $('#previewBody tr').each(function() {
                    var row = {};
                    $(this).find('td').each(function(index) {
                        var columnName = $('#previewHead th').eq(index).text();
                        if (columnName === 'type') {
                            row[columnName] = $(this).find('select').val();
                        } else {
                            row[columnName] = $(this).text();
                        }
                    });
                    data.push(row);
                });

                $.ajax({
                    url: '/save_transactions',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert('Transactions saved successfully');
                        window.location.href = '/';  // Redirect to home page
                    },
                    error: function(xhr, status, error) {
                        alert('Error saving transactions: ' + xhr.responseJSON.error);
                    }
                });
            });
        });
        </script>
</body>
</html>