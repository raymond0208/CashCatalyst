{% extends "base.html" %}

{% block content %}
    <div class="content-header">
        <div class="breadcrumb-nav">
            <span>Workspace</span> / <span>{{ request.endpoint }}</span>
        </div>
    </div>
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3" id="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} fade-out" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Tabs button area -->
    <ul class="nav nav-tabs" id="balanceTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="total-balance-tab" data-bs-toggle="tab" data-bs-target="#total-balance" type="button" role="tab" aria-controls="total-balance" aria-selected="true">Total Balance</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="balance-by-date-tab" data-bs-toggle="tab" data-bs-target="#balance-by-date" type="button" role="tab" aria-controls="balance-by-date" aria-selected="false">Check Balance by Date</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="anthropic-analysis-tab" data-bs-toggle="tab" data-bs-target="#anthropic-analysis" type="button" role="tab" aria-controls="anthropic-analysis" aria-selected="false">AI Analysis</button>
        </li>            
    </ul>

    <!-- Tab content area -->
    <div class="tab-content" id="balanceTabContent">
        <!-- Total Balance Tab -->
        <div class="tab-pane fade show active" id="total-balance" role="tabpanel" aria-labelledby="total-balance-tab">
            <div class="balance-section mt-4">
                <h3>Cash Flow Overview</h3>
                <div class="row">
                    <div class="col">
                        <div class="balance-item">
                            <h5>Initial Cash Balance</h5>
                            <p>${{ initial_balance }}</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="balance-item">
                            <h5>CFO (Cashflow from Operation)</h5>
                            <p>${{ total_cfo }}</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="balance-item">
                            <h5>CFI (Cashflow from Investment)</h5>
                            <p>${{ total_cfi }}</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="balance-item">
                            <h5>CFF (Cashflow from Financing)</h5>
                            <p>${{ total_cff }}</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="balance-item">
                            <h5>Latest Cash Balance</h5>
                            <p>${{ balance }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance by Date Tab -->
        <div id="balance-by-date" class="tab-pane fade" role="tabpanel" aria-labelledby="balance-by-date-tab">
            <div class="balance-section mt-4">
                <h5>Balance by Date</h5>
                <form id="balance-by-date-form" action="{{ url_for('balance_by_date') }}" method="post">
                    <div class="mb-3">
                        <input type="date" name="date" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Calculate</button>
                </form>
                <div id="balance-by-date-result" class="mt-3"></div>
                <img id="monthly-balance-chart" class="img-fluid mt-3" alt="Monthly Balance Chart">
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-pane fade" id="anthropic-analysis" role="tabpanel" aria-labelledby="anthropic-analysis-tab">
            <div class="balance-section mt-4">
                <h5>AI Financial Analysis</h5>
                
                <!-- Analysis Controls -->
                <div class="analysis-controls mb-4">
                    <button id="generate-analysis" class="btn btn-primary">Generate Advanced Analysis</button>
                    <button id="generate-cashflow-statement" class="btn btn-secondary">Generate Cash Flow Statement</button>
                </div>

                <!-- Loading Indicator -->
                <div id="loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Analysis Content Container -->
                <div id="analysis-content">
                    <!-- Advanced Analytics Dashboard -->
                    <div id="analysis-dashboard" style="display: none;">
                        <div class="row g-4">
                            <!-- Pattern Recognition Card -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">Pattern Recognition</div>
                                    <div class="card-body" id="pattern-recognition-content"></div>
                                </div>
                            </div>

                            <!-- Risk Assessment Card -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">Risk Assessment</div>
                                    <div class="card-body" id="risk-assessment-content"></div>
                                </div>
                            </div>

                            <!-- Seasonal Analysis Card -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">Seasonal Trends</div>
                                    <div class="card-body">
                                        <canvas id="seasonal-chart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Forecast Card -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">90-Day Forecast</div>
                                    <div class="card-body">
                                        <canvas id="forecast-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Raw Analysis Content -->
                    <div id="raw-analysis" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form to set the initial balance -->
    <div class="initial-balance-section">
        <form method="POST" action="/set-initial-balance">
          <h3>Set Initial Cash Balance</h3>
            <div class="mb-3">
                <input type="number" step="0.01" class="form-control" id="initial_balance" name="initial_balance" required>
            </div>
            <button type="submit" class="btn btn-secondary">Set Initial Balance</button>
        </form>
        <hr>
    </div>

    <!-- Form to set record transaction -->
    <div class="transaction-form-section">
        <form method="POST" action="{{ url_for('home') }}">
          <h3>Edit Cash Transaction</h3>
            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <input type="text" class="form-control" id="description" name="description" required>
            </div>
            <div class="mb-3">
                <label for="amount" class="form-label">Amount</label>
                <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
            </div>
            <div class="mb-3">
                <label for="amount" class="form-label">Type</label>
                <select class="form-select" id="type" name="type">
                    <optgroup label="Cashflow from operation">
                        <option value="Cash-customer">Cash from customers</option>
                        <option value="Salary-suppliers">Salary & Supplier payments</option>
                        <option value="Interest-paid">Interest paid</option>
                        <option value="Income-tax">Income taxes</option>
                        <option value="Other-cfo">Other operating cashflow</option>
                    </optgroup>
                    <optgroup label="Cashflow from investment">
                        <option value="Buy-property-equipments">Purchase of property&equipments</option>
                        <option value="Sell-property-equipments">Sell of property&equipments</option>
                        <option value="Buy-investment">Purchase of investments</option>
                        <option value="Sell-investment">Sale of investments</option>
                        <option value="Other-cfi">Other investing cashflow</option>
                    </optgroup>
                    <optgroup label="Cashflow from financing">
                        <option value="Issue-shares">Issuing shares</option>
                        <option value="borrowings">Borrowings</option>
                        <option value="Repay-borrowings">Repayment of borrowings</option>
                        <option value="Pay-dividends">Dividends paid</option>
                        <option value="Other-cff">Other financing cashflow</option>
                    </optgroup>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Add Transaction</button>
        </form>
        <hr>
    </div>

    <!-- Record table -->
    <div class="record-table-section">
      <h3>Transaction Records</h3>
        <table class="table" id="transactionTable">
            <thead>
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Description</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Type</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr class='table-row' draggable="true">
                    <td>{{ transaction.date }}</td>
                    <td>{{ transaction.description }}</td>
                    <td>{{ transaction.amount }}</td>
                    <td>{{ transaction.type }}</td>
                    <td>
                        <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-primary">Edit</a>
                        <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% for page_num in transactions.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if transactions.page == page_num %}
                        <li class="page-item active">
                            <a class="page-link" href="{{ url_for('home', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('home', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </nav>

    <!-- Export Buttons -->
    <div class="export-buttons-section">
        <a href="{{ url_for('upload_route') }}" class="btn btn-primary">Upload Cashflow Data</a>
        <a href="{{  url_for('export', file_type='csv')  }}" class="btn btn-success">Export as CSV</a>
        <a href="{{  url_for('export', file_type='excel')  }}" class="btn btn-success">Export as Excel</a>
    </div>
{% endblock %}
